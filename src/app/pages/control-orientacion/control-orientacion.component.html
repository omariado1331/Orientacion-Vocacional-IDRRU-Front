<div class="container-fluid vh-100 d-flex align-items-center justify-content-center" *ngIf="!isAuthenticated">
  <div class="card shadow-lg border-0" style="max-width: 400px; width: 100%;">
    <div class="card-body p-4 text-umsa">
      <!-- Encabezado con logo a la izquierda y texto a la derecha -->
      <div class="login-header d-flex align-items-center bg-umsa-blue-dark text-white rounded mb-4 px-3 py-2">
        <img [src]="logoUrl" alt="Logo Universidad" class="img-fluid me-3" style="max-height: 110px;">
        <div>
          <h5 class="mb-1 fw-bold">Sistema de Orientación Vocacional</h5>
          <small class="text-light">Inicie sesión para acceder al panel de control</small>
        </div>
      </div>

      <form [formGroup]="loginForm" (ngSubmit)="onSubmit()">
        <div class="mb-3">
          <label for="username" class="form-label">Usuario</label>
          <div class="input-group">
            <span class="input-group-text bg-umsa-blue text-white"><i class="bi bi-person-fill"></i></span>
            <input type="text" id="username" formControlName="username" class="form-control"
              placeholder="Ingrese su usuario"
              [ngClass]="{'is-invalid': loginForm.get('username')?.touched && loginForm.get('username')?.invalid}">
          </div>
          <div class="invalid-feedback"
            *ngIf="loginForm.get('username')?.touched && loginForm.get('username')?.invalid">
            Usuario requerido
          </div>
        </div>

        <div class="mb-4">
          <label for="password" class="form-label">Contraseña</label>
          <div class="input-group">
            <span class="input-group-text bg-umsa-blue text-white"><i class="bi bi-lock-fill"></i></span>
            <input type="password" id="password" formControlName="password" class="form-control"
              placeholder="Ingrese su contraseña"
              [ngClass]="{'is-invalid': loginForm.get('password')?.touched && loginForm.get('password')?.invalid}">
          </div>
          <div class="invalid-feedback"
            *ngIf="loginForm.get('password')?.touched && loginForm.get('password')?.invalid">
            Contraseña requerida
          </div>
        </div>

        <div class="alert alert-danger" *ngIf="error">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>
          {{ error }}
        </div>

        <button type="submit" class="btn btn-umsa w-100 py-2" [disabled]="loginForm.invalid || loading">
          <span *ngIf="loading" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
          <i *ngIf="!loading" class="bi bi-box-arrow-in-right me-2"></i>
          Iniciar Sesión
        </button>
      </form>
      <div class="text-center mt-4">
        <small class="text-muted">© {{ 2025 }} UMSA - Sistema de Orientación Vocacional</small>
      </div>
    </div>
  </div>
</div>

<!-- Panel de control cuando está autenticado -->
<div *ngIf="isAuthenticated">
  <!-- Header con logo y título -->
  <header class="bg-umsa-blue-dark shadow-sm mb-4">
    <div class="container-fluid py-3">
      <div class="d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
          <img [src]="logoUrl" alt="Logo Universidad" class="me-3" style="height: 50px;">
          <h1 class="h3 mb-0 text-light">Sistema de Orientación Vocacional</h1>
        </div>
        <div>
          <button class="btn btn-outline-danger" (click)="logout()">
            <i class="bi bi-box-arrow-right me-2"></i>Cerrar Sesión
          </button>
        </div>
      </div>
    </div>
  </header>
  <div class="container-fluid px-4">
    <!-- Sección de título y estadísticas -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2><i class="bi bi-speedometer2 me-2"></i>Panel de Control</h2>
      <div>
        <div class="btn-group" role="group">
          <button class="btn btn-outline-primary dropdown-toggle" type="button" id="exportarDropdown"
            data-bs-toggle="dropdown" aria-expanded="false"
            [disabled]="exportando || estudiantesFiltrados.length === 0">
            <i class="bi bi-download me-2"></i>Exportar
            <span *ngIf="exportando" class="spinner-border spinner-border-sm ms-2" role="status"
              aria-hidden="true"></span>
          </button>
          <ul class="dropdown-menu" aria-labelledby="exportarDropdown">
            <li><a class="dropdown-item" (click)="exportarEstudiantes('excel')"><i
                  class="bi bi-file-earmark-excel me-2"></i>Excel</a></li>
            <li><a class="dropdown-item" (click)="exportarEstudiantes('pdf')"><i
                  class="bi bi-file-earmark-pdf me-2"></i>PDF</a></li>
          </ul>
        </div>
      </div>
    </div>
    <!-- Sección de búsqueda y filtros -->
    <div class="card shadow mb-4">
      <div class="card-header py-3 d-flex justify-content-between align-items-center">
        <h5 class="mb-0 text-primary"><i class="bi bi-funnel-fill me-2"></i>Filtros y Búsqueda</h5>
        <button class="btn btn-sm btn-warning" (click)="limpiarTodosFiltros()">
          <i class="bi bi-x-circle-fill me-1"></i> Limpiar Filtros
        </button>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <!-- Búsqueda global -->
          <div class="col-md-12">
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-search"></i></span>
              <input type="text" class="form-control" placeholder="Buscar por nombre, apellido, CI o colegio..."
                [value]="searchQuery" (input)="buscarGlobal($event)">
            </div>
          </div>

          <!-- Filtros -->
          <div class="col-md-3">
            <label class="form-label">Provincia</label>
            <select class="form-select" [(ngModel)]="filtros.provincia" (change)="onProvinciaChange(filtros.provincia)">
              <option value="">Todas las provincias</option>
              <option *ngFor="let provincia of opcionesFiltros.provincias" [value]="provincia.idProvincia">
                {{ provincia.nombre }}
              </option>
            </select>
          </div>

          <div class="col-md-3">
            <label class="form-label">Municipio</label>
            <select class="form-select" [(ngModel)]="filtros.municipio"
              (change)="aplicarFiltro('municipio', filtros.municipio)">
              <option value="">Todos los municipios</option>
              <option *ngFor="let municipio of opcionesFiltros.municipios" [value]="municipio.idMunicipio">
                {{ municipio.nombre }}
              </option>
            </select>
          </div>

          <div class="col-md-3">
            <label class="form-label">Colegio</label>
            <select class="form-select" [(ngModel)]="filtros.colegio"
              (change)="aplicarFiltro('colegio', filtros.colegio)">
              <option value="">Todos los colegios</option>
              <option *ngFor="let colegio of opcionesFiltros.colegios" [value]="colegio">
                {{ colegio }}
              </option>
            </select>
          </div>

          <div class="col-md-3">
            <label class="form-label">Curso</label>
            <select class="form-select" [(ngModel)]="filtros.curso" (change)="aplicarFiltro('curso', filtros.curso)">
              <option value="">Todos los cursos</option>
              <option *ngFor="let curso of opcionesFiltros.cursos" [value]="curso">
                {{ curso }}
              </option>
            </select>
          </div>

          <!-- Filtrado por rango de fechas -->
          <div class="col-md-6">
            <label class="form-label">Rango de Fechas</label>
            <div class="d-flex">
              <div class="input-group me-2">
                <span class="input-group-text"><i class="bi bi-calendar-event"></i></span>
                <input type="date" class="form-control" [(ngModel)]="filtros.fechaInicio" placeholder="Fecha inicio">
              </div>
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-calendar-event"></i></span>
                <input type="date" class="form-control" [(ngModel)]="filtros.fechaFin" placeholder="Fecha fin">
              </div>
              <button class="btn btn-primary ms-2" (click)="aplicarFiltroFecha()">
                <i class="bi bi-funnel"></i>
              </button>
            </div>
          </div>

          <div class="col-md-6">
            <label class="form-label">Fecha específica</label>
            <select class="form-select" [(ngModel)]="filtros.fecha" (change)="aplicarFiltro('fecha', filtros.fecha)">
              <option value="">Todas las fechas</option>
              <option *ngFor="let fecha of opcionesFiltros.fechasRegistro" [value]="fecha">
                {{ fecha }}
              </option>
            </select>
          </div>
        </div>
      </div>
    </div>
    <!-- Modal para Ver Perfil de Estudiante -->
    <div class="modal fade" [ngClass]="{'show d-block': modalPerfilVisible}" tabindex="-1"
      [ngStyle]="{'display': modalPerfilVisible ? 'block' : 'none'}" aria-labelledby="perfilEstudianteModalLabel"
      [attr.aria-hidden]="!modalPerfilVisible">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content border-0 shadow">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="perfilEstudianteModalLabel">
              <i class="bi bi-person-badge me-2"></i>
              Perfil del Estudiante
            </h5>
            <button type="button" class="btn-close btn-close-white" (click)="cerrarModalPerfil()"></button>
          </div>
          <div class="modal-body p-0">
            <!-- Spinner de carga -->
            <div *ngIf="loading" class="text-center py-5">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
              </div>
              <p class="mt-2 text-muted">Cargando información del estudiante...</p>
            </div>

            <!-- Contenido del perfil -->
            <div *ngIf="!loading && estudianteSeleccionado" class="perfil-container">
              <!-- Banner y datos principales -->
              <div class="bg-light p-4 mb-3 border-bottom position-relative">
                <div class="row align-items-center">
                  <div class="col-auto">
                    <div
                      class="bg-primary text-white d-flex align-items-center justify-content-center px-3 py-2 rounded-circle">
                      <span class="fs-1">{{ estudianteSeleccionado.nombre.charAt(0) }}{{
                        estudianteSeleccionado.apPaterno.charAt(0) }}</span>
                    </div>
                  </div>
                  <div class="col">
                    <h4 class="mb-1">{{ estudianteSeleccionado.nombre }} {{ estudianteSeleccionado.apPaterno }} {{
                      estudianteSeleccionado.apMaterno }}</h4>
                    <div class="d-flex flex-wrap gap-3 text-muted">
                      <div><i class="bi bi-credit-card me-1"></i> {{ estudianteSeleccionado.ciEstudiante }}</div>
                      <div><i class="bi bi-mortarboard me-1"></i> {{ estudianteSeleccionado.curso }}</div>
                      <div><i class="bi bi-building me-1"></i> {{ estudianteSeleccionado.colegio }}</div>
                      <div><i class="bi bi-pin-map me-1"></i> {{ getMunicipioNombre(estudianteSeleccionado.id_municipio)
                        }}</div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="px-4">
                <!-- Información personal -->
                <div class="card mb-4 border-0 shadow-sm">
                  <div class="card-header bg-white py-3">
                    <h5 class="mb-0 d-flex align-items-center">
                      <i class="bi bi-person-lines-fill me-2 text-primary"></i>
                      Datos Personales
                    </h5>
                  </div>
                  <div class="card-body">
                    <div class="row g-3">
                      <div class="col-md-6">
                        <div class="info-item mb-3">
                          <label class="d-block text-uppercase small text-muted mb-1">CI:</label>
                          <p class="mb-0 fs-5">{{ estudianteSeleccionado.ciEstudiante }}</p>
                        </div>
                        <div class="info-item mb-3">
                          <label class="d-block text-uppercase small text-muted mb-1">Nombre Completo:</label>
                          <p class="mb-0 fs-5">{{ estudianteSeleccionado.nombre }} {{ estudianteSeleccionado.apPaterno
                            }} {{ estudianteSeleccionado.apMaterno }}</p>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="info-item mb-3">
                          <label class="d-block text-uppercase small text-muted mb-1">Edad:</label>
                          <p class="mb-0 fs-5">{{ estudianteSeleccionado.edad }} años</p>
                        </div>
                        <div class="info-item mb-3">
                          <label class="d-block text-uppercase small text-muted mb-1">Celular:</label>
                          <p class="mb-0 fs-5">
                            <span *ngIf="estudianteSeleccionado.celular">
                              <i class="bi bi-telephone me-1"></i>{{ estudianteSeleccionado.celular }}
                            </span>
                            <span *ngIf="!estudianteSeleccionado.celular" class="text-muted fst-italic">No
                              especificado</span>
                          </p>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="info-item mb-3">
                          <label class="d-block text-uppercase small text-muted mb-1">Colegio:</label>
                          <p class="mb-0 fs-5">{{ estudianteSeleccionado.colegio }}</p>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="info-item mb-3">
                          <label class="d-block text-uppercase small text-muted mb-1">Curso:</label>
                          <p class="mb-0 fs-5">{{ estudianteSeleccionado.curso }}</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Resultados de Orientación -->
                <div *ngIf="resultadoEstudiante && resultadoEstudiante.length > 0">
                  <h5 class="mb-3 d-flex align-items-center">
                    <span class="badge bg-primary rounded-pill me-2">{{ resultadoEstudiante.length }}</span>
                    <i class="bi bi-graph-up me-2 text-primary"></i>
                    Resultados de Orientación Vocacional
                  </h5>

                  <!-- Tabs para múltiples resultados -->
                  <ul class="nav nav-tabs mb-3" *ngIf="resultadoEstudiante.length > 1">
                    <li class="nav-item" *ngFor="let resultado of resultadoEstudiante; let i = index">
                      <button class="nav-link" [ngClass]="{'active': i === 0}" data-bs-toggle="tab"
                        [attr.data-bs-target]="'#resultado-' + i">
                        Resultado {{ i + 1 }}
                        <small class="ms-2 text-muted">{{ resultado.fecha | date:'dd/MM/yyyy' }}</small>
                      </button>
                    </li>
                  </ul>

                  <div class="tab-content">
                    <div class="tab-pane fade show" [ngClass]="{'active': i === 0}"
                      *ngFor="let resultado of resultadoEstudiante; let i = index" [attr.id]="'resultado-' + i">
                      <div class="card mb-4 border-0 shadow-sm">
                        <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                          <h6 class="mb-0 d-flex align-items-center">
                            <i class="bi bi-calendar-check me-2 text-primary"></i>
                            Evaluación del {{ resultado.fecha | date:'dd/MM/yyyy HH:mm' }}
                          </h6>
                          <span class="badge bg-success">Completado</span>
                        </div>
                        <div class="card-body">
                          <div class="row mb-4">
                            <div class="col-md-6">
                              <div class="card h-100 border-0 bg-light">
                                <div class="card-body">
                                  <h6 class="card-title text-primary">
                                    <i class="bi bi-star me-2"></i>Interés y Aptitud
                                  </h6>
                                  <div class="mb-3">
                                    <label class="d-block text-uppercase small text-muted mb-1">Interés:</label>
                                    <div class="d-flex align-items-center">
                                      <span class="fs-5 me-2">{{ resultado.interes }}</span>
                                    </div>
                                  </div>
                                  <div class="mb-0">
                                    <label class="d-block text-uppercase small text-muted mb-1">Aptitud:</label>
                                    <div class="d-flex align-items-center">
                                      <span class="fs-5 me-2">{{ resultado.aptitud }}</span>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                            <div class="col-md-6">
                              <div class="card h-100 border-0 bg-light">
                                <div class="card-body">
                                  <h6 class="card-title text-primary">
                                    <i class="bi bi-award me-2"></i>Evaluación Holland
                                  </h6>
                                  <div class="mb-3">
                                    <label class="d-block text-uppercase small text-muted mb-1">Puntaje Holland:</label>
                                    <p class="mb-0 fs-5">{{ resultado.puntajeHolland }}</p>
                                  </div>
                                  <div *ngIf="resultado.facultad?.nombre">
                                    <label class="d-block text-uppercase small text-muted mb-1">Facultad
                                      recomendada:</label>
                                    <p class="mb-0 fs-5">
                                      <span class="badge bg-primary me-2">
                                        <i class="bi bi-building me-1"></i>
                                      </span>
                                      {{ resultado.facultad.nombre }}
                                    </p>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>

                          <!-- Resultados detallados -->
                          <div class="row mb-3">
                            <!-- Datos CHASIDE específicos -->
                            <div class="col-md-6 mb-3" *ngIf="resultado.chaside">
                              <div class="card h-100 border-0 bg-light">
                                <div class="card-body">
                                  <h6 class="card-title text-primary d-flex align-items-center">
                                    <i class="bi bi-clipboard-data me-2"></i>
                                    Test CHASIDE
                                  </h6>
                                  <div class="mb-0">
                                    <label class="d-block text-uppercase small text-muted mb-1">Código CHASIDE:</label>
                                    <div class="chaside-code">
                                      <span class="text-uppercase fw-bold me-1">
                                        {{ resultado.chaside.codigo }}

                                      </span>
                                    </div>
                                    <p class="mt-2 small text-muted mb-0">
                                      C: Administrativas y Contables, H: Humanísticas, A: Artísticas, S: Medicina y Cs.
                                      de la Salud,
                                      I: Ingeniería, D: Defensa y Seguridad, E: Ciencias Exactas
                                    </p>
                                  </div>
                                </div>
                              </div>
                            </div>

                            <!-- Datos Holland específicos -->
                            <div class="col-md-6 mb-3" *ngIf="resultado.holland">
                              <div class="card h-100 border-0 bg-light">
                                <div class="card-body">
                                  <h6 class="card-title text-primary d-flex align-items-center">
                                    <i class="bi bi-person-bounding-box me-2"></i>
                                    Test Holland
                                  </h6>
                                  <div class="mb-0">
                                    <label class="d-block text-uppercase small text-muted mb-1">Tipo de
                                      personalidad:</label>
                                    <p class="mb-0 fs-5">{{ resultado.holland.personalidad }}</p>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>

                          <!-- Recomendaciones específicas -->
                          <div class="card border-0 bg-primary bg-opacity-10 mb-0">
                            <div class="card-body">
                              <h6 class="card-title text-primary">
                                <i class="bi bi-lightbulb me-2"></i>
                                Recomendaciones
                              </h6>
                              <p class="mb-0">
                                Basado en los resultados de los tests, se recomienda explorar carreras relacionadas con
                                <strong>{{ resultado.facultad?.nombre || 'las áreas de mayor puntaje' }}</strong>.
                                Es importante complementar estos resultados con una orientación personalizada.
                              </p>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="alert alert-info d-flex align-items-center" *ngIf="!resultadoEstudiante?.length">
                  <i class="bi bi-info-circle fs-4 me-3"></i>
                  <div>
                    <h6 class="mb-1">Sin resultados disponibles</h6>
                    <p class="mb-0">Este estudiante aún no tiene resultados de orientación vocacional registrados.</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer bg-light">
            <button type="button" class="btn btn-outline-secondary px-4 py-2 rounded-pill fw-semibold"
              (click)="cerrarModalPerfil()">
              <i class="bi bi-x-circle me-2"></i>
              Cerrar
            </button>
            <button type="button" class="btn btn-primary px-4 py-2 rounded-pill fw-semibold shadow-sm"
              *ngIf="estudianteSeleccionado" (click)="exportarPerfilPDF()">
              <i class="bi bi-file-earmark-pdf me-2"></i>
              Exportar PDF
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- Modal para Editar Estudiante y Resultados -->
    <div class="modal fade" [ngClass]="{'show d-block': modalEditarVisible}" tabindex="-1"
      [ngStyle]="{'display': modalEditarVisible ? 'block' : 'none'}" aria-labelledby="editarEstudianteModalLabel"
      [attr.aria-hidden]="!modalEditarVisible">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content shadow-lg border-0 rounded-4">
          <div class="modal-header bg-primary text-white">
            <div class="d-flex align-items-center">
              <div>
                <h4 class="modal-title mb-1 fw-bold" id="editarEstudianteModalLabel">
                  Editar Estudiante
                </h4>
              </div>
            </div>
            <button type="button" class="btn-close btn-close-white opacity-75" (click)="cerrarModalEditar()"></button>
          </div>

          <div class="modal-body p-0">
            <!-- Sección de Información Personal -->
            <div class="p-4 border-bottom bg-light bg-opacity-50">
              <div class="d-flex align-items-center mb-4">
                <div>
                  <h5 class="mb-1 fw-bold text-primary">Datos Personales</h5>
                </div>
              </div>

              <form *ngIf="editarForm" [formGroup]="editarForm">
                <div class="row g-4">
                  <!-- CI y Nombre -->
                  <div class="col-md-6">
                    <div class="form-floating">
                      <input type="text" class="form-control border-2 rounded-3" id="ciEstudiante"
                        formControlName="ciEstudiante" placeholder="CI"
                        [ngClass]="{'is-invalid border-danger': editarForm.controls['ciEstudiante'].invalid && editarForm.controls['ciEstudiante'].touched}">
                      <label for="ciEstudiante" class="text-muted">
                        <i class="bi bi-card-text me-2"></i>CI *
                      </label>
                      <div class="invalid-feedback fw-semibold"
                        *ngIf="editarForm.controls['ciEstudiante'].invalid && editarForm.controls['ciEstudiante'].touched">
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        El CI es requerido y debe ser único
                      </div>
                    </div>
                  </div>

                  <div class="col-md-6">
                    <div class="form-floating">
                      <input type="text" class="form-control border-2 rounded-3" id="nombre" formControlName="nombre"
                        placeholder="Nombre"
                        [ngClass]="{'is-invalid border-danger': editarForm.controls['nombre'].invalid && editarForm.controls['nombre'].touched}">
                      <label for="nombre" class="text-muted">
                        <i class="bi bi-person me-2"></i>Nombre *
                      </label>
                      <div class="invalid-feedback fw-semibold"
                        *ngIf="editarForm.controls['nombre'].invalid && editarForm.controls['nombre'].touched">
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        El nombre es requerido
                      </div>
                    </div>
                  </div>

                  <!-- Apellidos -->
                  <div class="col-md-6">
                    <div class="form-floating">
                      <input type="text" class="form-control border-2 rounded-3" id="apPaterno"
                        formControlName="apPaterno" placeholder="Apellido Paterno"
                        [ngClass]="{'is-invalid border-danger': editarForm.controls['apPaterno'].invalid && editarForm.controls['apPaterno'].touched}">
                      <label for="apPaterno" class="text-muted">
                        <i class="bi bi-person-badge me-2"></i>Apellido Paterno *
                      </label>
                      <div class="invalid-feedback fw-semibold"
                        *ngIf="editarForm.controls['apPaterno'].invalid && editarForm.controls['apPaterno'].touched">
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        El apellido paterno es requerido
                      </div>
                    </div>
                  </div>

                  <div class="col-md-6">
                    <div class="form-floating">
                      <input type="text" class="form-control border-2 rounded-3" id="apMaterno"
                        formControlName="apMaterno" placeholder="Apellido Materno">
                      <label for="apMaterno" class="text-muted">
                        <i class="bi bi-person-badge me-2"></i>Apellido Materno
                      </label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-floating">
                      <input type="text" class="form-control border-2 rounded-3" id="colegio" formControlName="colegio"
                        placeholder="Colegio"
                        [ngClass]="{'is-invalid border-danger': editarForm.controls['colegio'].invalid && editarForm.controls['colegio'].touched}">
                      <label for="colegio" class="text-muted">
                        <i class="bi bi-building me-2"></i>Colegio *
                      </label>
                      <div class="invalid-feedback fw-semibold"
                        *ngIf="editarForm.controls['colegio'].invalid && editarForm.controls['colegio'].touched">
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        El colegio es requerido
                      </div>
                    </div>
                  </div>

                  <div class="col-md-6">
                    <div class="form-floating">
                      <input type="text" class="form-control border-2 rounded-3" id="curso" formControlName="curso"
                        placeholder="Curso"
                        [ngClass]="{'is-invalid border-danger': editarForm.controls['curso'].invalid && editarForm.controls['curso'].touched}">
                      <label for="curso" class="text-muted">
                        <i class="bi bi-book me-2"></i>Curso *
                      </label>
                      <div class="invalid-feedback fw-semibold"
                        *ngIf="editarForm.controls['curso'].invalid && editarForm.controls['curso'].touched">
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        El curso es requerido
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-floating">
                      <input type="number" class="form-control border-2 rounded-3" id="edad" formControlName="edad"
                        placeholder="Edad"
                        [ngClass]="{'is-invalid border-danger': editarForm.controls['edad'].invalid && editarForm.controls['edad'].touched}">
                      <label for="edad" class="text-muted">
                        <i class="bi bi-calendar3 me-2"></i>Edad *
                      </label>
                      <div class="invalid-feedback fw-semibold"
                        *ngIf="editarForm.controls['edad'].invalid && editarForm.controls['edad'].touched">
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        La edad debe ser entre 10 y 30 años
                      </div>
                    </div>
                  </div>

                  <div class="col-md-8">
                    <div class="form-floating">
                      <input type="text" class="form-control border-2 rounded-3" id="celular" formControlName="celular"
                        placeholder="Celular"
                        [ngClass]="{'is-invalid border-danger': editarForm.controls['celular'].invalid && editarForm.controls['celular'].touched}">
                      <label for="celular" class="text-muted">
                        <i class="bi bi-phone me-2"></i>Celular
                      </label>
                      <div class="invalid-feedback fw-semibold"
                        *ngIf="editarForm.controls['celular'].invalid && editarForm.controls['celular'].touched">
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        El celular debe contener solo números
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-floating">
                      <select class="form-select border-2 rounded-3" id="id_provincia" formControlName="id_provincia"
                        [ngClass]="{'is-invalid border-danger': editarForm.controls['id_provincia'].invalid && editarForm.controls['id_provincia'].touched}"
                        (change)="onProvinciaChangeEditar($event)">
                        <option [value]="null">Seleccione una provincia</option>
                        <option *ngFor="let provincia of provincias" [value]="provincia.id">
                          {{ provincia.nombre }}
                        </option>
                      </select>
                      <label for="id_provincia" class="text-muted">
                        <i class="bi bi-map me-2"></i>Provincia *
                      </label>
                      <div class="invalid-feedback fw-semibold"
                        *ngIf="editarForm.controls['id_provincia'].invalid && editarForm.controls['id_provincia'].touched">
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        Seleccione una provincia
                      </div>
                    </div>
                  </div>

                  <div class="col-md-6">
                    <div class="form-floating">
                      <select class="form-select border-2 rounded-3" id="id_municipio" formControlName="id_municipio"
                        [ngClass]="{'is-invalid border-danger': editarForm.controls['id_municipio'].invalid && editarForm.controls['id_municipio'].touched}"
                        [disabled]="!editarForm.get('id_provincia')?.value">
                        <option [value]="null">Seleccione un municipio</option>
                        <option *ngFor="let municipio of municipiosFiltrados" [value]="municipio.idMunicipio">
                          {{ municipio.nombre }}
                        </option>
                      </select>
                      <label for="id_municipio" class="text-muted">
                        <i class="bi bi-pin-map me-2"></i>Municipio *
                      </label>
                      <div class="invalid-feedback fw-semibold"
                        *ngIf="editarForm.controls['id_municipio'].invalid && editarForm.controls['id_municipio'].touched">
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        Seleccione un municipio
                      </div>
                    </div>
                  </div>
                </div>
              </form>
            </div>

            <!-- Resultados de Orientación Vocacional -->
            <div class="p-4">
              <div class="d-flex align-items-center mb-4">
                <div class="bg-success bg-opacity-10 rounded-circle p-2 me-3">
                  <i class="bi bi-graph-up text-success fs-5"></i>
                </div>
                <div>
                  <h5 class="mb-1 fw-bold text-success">Resultados de Orientación Vocacional</h5>
                  <small class="text-muted">Historial de evaluaciones realizadas</small>
                </div>
              </div>

              <div *ngIf="resultados.length === 0"
                class="alert alert-info border-0 rounded-4 d-flex align-items-center">
                <div class="bg-info bg-opacity-10 rounded-circle p-2 me-3">
                  <i class="bi bi-info-circle text-info"></i>
                </div>
                <div>
                  <strong>Sin resultados</strong><br>
                  <small>No hay resultados de orientación registrados para este estudiante</small>
                </div>
              </div>

              <div *ngIf="resultados.length > 0" class="table-responsive rounded-3 border">
                <table class="table mb-0 align-middle">
                  <thead class="table-light">
                    <tr>
                      <th class="border-0 fw-bold text-muted py-3">
                        <i class="bi bi-calendar3 me-2"></i>Fecha
                      </th>
                      <th class="border-0 fw-bold text-muted py-3">
                        Interés
                      </th>
                      <th class="border-0 fw-bold text-muted py-3">
                        Aptitud
                      </th>
                      <th class="border-0 fw-bold text-muted py-3">
                        CHASIDE
                      </th>
                      <th class="border-0 fw-bold text-muted py-3">
                        Holland
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let r of resultados; let i = index" class="border-bottom">
                      <td class="py-3">
                        <div class="bg-ligh px-3 py-1 ">
                          <small class="fw-semibold">{{ r.fecha | date:'dd/MM/yyyy' }}</small><br>
                          <small class="text-muted">{{ r.fecha | date:'HH:mm' }}</small>
                        </div>
                      </td>

                      <td class="py-3">
                        <span class="badge bg-primary bg-opacity-10 text-primary px-3 py-2 rounded-pill fw-semibold">
                          {{ r.interes }}
                        </span>
                      </td>

                      <td class="py-3">
                        <span class="badge bg-success bg-opacity-10 text-success px-3 py-2 rounded-pill fw-semibold">
                          {{ r.aptitud }}
                        </span>
                      </td>

                      <td class="py-3" *ngIf="r.chaside; else chasideEmpty">
                        <div class="bg-warning bg-opacity-10 rounded-3 p-2">
                          <div class="fw-bold text-warning mb-1">{{ r.chaside.codigo }}</div>
                          <small class="text-muted">{{ r.chaside.descripcion }}</small>
                        </div>
                      </td>
                      <ng-template #chasideEmpty>
                        <td class="py-3">
                          <span class="text-muted">—</span>
                        </td>
                      </ng-template>

                      <td class="py-3" *ngIf="r.holland; else hollandEmpty">
                        <div class="bg-info bg-opacity-10 rounded-3 p-2">
                          <div class="fw-bold text-info mb-1">{{ r.holland.personalidad }}</div>
                          <small *ngIf="r.puntajeHolland" class="text-muted">
                            Puntaje: {{ r.puntajeHolland }}
                          </small>
                        </div>
                      </td>
                      <ng-template #hollandEmpty>
                        <td class="py-3">
                          <span class="text-muted">—</span>
                        </td>
                      </ng-template>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          <div class="modal-footer bg-light bg-opacity-50 border-0 p-4">
            <div class="d-flex justify-content-end gap-3 w-100">
              <button type="button" class="btn btn-outline-secondary px-4 py-2 rounded-pill fw-semibold"
                (click)="cerrarModalEditar()">
                <i class="bi bi-x-circle me-2"></i>
                Cancelar
              </button>
              <button type="button" class="btn btn-primary px-4 py-2 rounded-pill fw-semibold shadow-sm"
                [disabled]="!esFormularioValido()" (click)="guardarEdicionCompletaEstudiante()">
                <i class="bi bi-check-circle me-2"></i>
                Guardar Cambios
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Tabla de estudiantes -->
    <div class="card shadow mb-4">
      <div class="card-header py-3">
        <h5 class="mb-0 text-primary"><i class="bi bi-table me-2"></i>Listado de Estudiantes</h5>
      </div>
      <div class="card-body">
        <!-- Selector de items por página -->
        <div class="row mb-3">
          <div class="col-md-6">
            <div class="d-flex align-items-center">
              <span class="me-2">Mostrar</span>
              <select class="form-select form-select-sm" style="width: auto" [(ngModel)]="paginacion.itemsPorPagina"
                (change)="cambiarItemsPorPagina(paginacion.itemsPorPagina)">
                <option [value]="10">10</option>
                <option [value]="25">25</option>
                <option [value]="50">50</option>
                <option [value]="100">100</option>
              </select>
              <span class="ms-2">registros</span>
            </div>
          </div>
          <div class="col-md-6 text-end">
            <span class="text-muted">
              Mostrando {{ estudiantesFiltrados.length > 0 ? (paginacion.paginaActual - 1) * paginacion.itemsPorPagina +
              1 : 0 }}
              a {{ Math.min(paginacion.paginaActual * paginacion.itemsPorPagina, estudiantesFiltrados.length) }}
              de {{ estudiantesFiltrados.length }} estudiantes
            </span>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-bordered table-hover ">
            <thead class="table-dark">
              <tr>
                <th class="cursor-pointer" (click)="ordenarPor('ciEstudiante')">
                  CI
                  <i *ngIf="ordenamiento.columna === 'ciEstudiante'"
                    [ngClass]="ordenamiento.direccion === 'asc' ? 'bi bi-sort-up' : 'bi bi-sort-down'"></i>
                </th>
                <th class="cursor-pointer" (click)="ordenarPor('nombre')">
                  Nombre
                  <i *ngIf="ordenamiento.columna === 'nombre'"
                    [ngClass]="ordenamiento.direccion === 'asc' ? 'bi bi-sort-up' : 'bi bi-sort-down'"></i>
                </th>
                <th class="cursor-pointer" (click)="ordenarPor('apellidos')">
                  Apellidos
                  <i *ngIf="ordenamiento.columna === 'apellidos'"
                    [ngClass]="ordenamiento.direccion === 'asc' ? 'bi bi-sort-up' : 'bi bi-sort-down'"></i>
                </th>
                <th class="cursor-pointer" (click)="ordenarPor('colegio')">
                  Colegio
                  <i *ngIf="ordenamiento.columna === 'colegio'"
                    [ngClass]="ordenamiento.direccion === 'asc' ? 'bi bi-sort-up' : 'bi bi-sort-down'"></i>
                </th>
                <th class="cursor-pointer"> Celular </th>
                <th class="cursor-pointer"> Municipio </th>
                <th class="text-center">Acciones</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngIf="estudiantesPaginados.length === 0">
                <td colspan="7" class="text-center py-4">
                  <i class="bi bi-exclamation-circle text-muted me-2"></i>
                  No se encontraron registros que coincidan con los criterios de búsqueda
                </td>
              </tr>
              <tr *ngFor="let estudiante of estudiantesPaginados; let i = index">
                <td>{{ estudiante.ciEstudiante }}</td>
                <td>{{ estudiante.nombre }}</td>
                <td>{{ estudiante.apPaterno }} {{ estudiante.apMaterno }}</td>
                <td>{{ estudiante.colegio }}</td>
                <td>{{ estudiante.celular }}</td>
                <td>{{ getMunicipioNombre(estudiante.id_municipio) }}</td>

                <td class="text-center">
                  <div class="btn-group btn-group-sm" role="group">
                    <button class="btn btn-light px-3 py-2 rounded-start btn-outline-primary" title="Ver Perfil"
                      (click)="verPerfilEstudiante(estudiante.idEstudiante)" style="transition: all 0.2s;">
                      <i class="bi bi-person-badge fs-5"></i>
                    </button>

                    <button class="btn btn-light px-3 py-2 btn-outline-warning" title="Editar"
                      (click)="abrirModalEditar(estudiante)" style="transition: all 0.2s; margin: 0 2px;">
                      <i class="bi bi-pencil fs-5"></i>
                    </button>

                    <button class="btn btn-light px-3 py-2 rounded-end btn-outline-danger" title="Eliminar"
                      (click)="eliminarEstudiante(estudiante.idEstudiante)" style="transition: all 0.2s;">
                      <i class="bi bi-trash fs-5"></i>
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <!-- Paginación -->
        <div class="d-flex justify-content-center mt-3" *ngIf="paginacion.totalPaginas > 1">
          <nav aria-label="Paginación de resultados">
            <ul class="pagination">
              <li class="page-item" [ngClass]="{'disabled': paginacion.paginaActual === 1}">
                <a class="page-link" (click)="cambiarPagina(1)" aria-label="Primera" tabindex="-1">
                  <span aria-hidden="true">&laquo;</span>
                </a>
              </li>
              <li class="page-item" [ngClass]="{'disabled': paginacion.paginaActual === 1}">
                <a class="page-link" (click)="cambiarPagina(paginacion.paginaActual - 1)" aria-label="Anterior"
                  tabindex="-1">
                  <span aria-hidden="true">&lt;</span>
                </a>
              </li>

              <ng-container *ngFor="let pagina of [].constructor(paginacion.totalPaginas); let i = index">
                <li class="page-item" *ngIf="(i + 1) === 1 ||
                                      (i + 1) === paginacion.totalPaginas ||
                                      (i + 1) >= paginacion.paginaActual - 1 &&
                                      (i + 1) <= paginacion.paginaActual + 1"
                  [ngClass]="{'active': i + 1 === paginacion.paginaActual}">
                  <a class="page-link" (click)="cambiarPagina(i + 1)" tabindex="-1">{{ i + 1 }}</a>
                </li>
                <li class="page-item disabled" *ngIf="(i + 1) === 2 && paginacion.paginaActual > 3">
                  <span class="page-link">...</span>
                </li>
                <li class="page-item disabled"
                  *ngIf="(i + 1) === paginacion.totalPaginas - 1 && paginacion.paginaActual < paginacion.totalPaginas - 2">
                  <span class="page-link">...</span>
                </li>
              </ng-container>

              <li class="page-item" [ngClass]="{'disabled': paginacion.paginaActual === paginacion.totalPaginas}">
                <a class="page-link" (click)="cambiarPagina(paginacion.paginaActual + 1)" aria-label="Siguiente"
                  tabindex="-1">
                  <span aria-hidden="true">&gt;</span>
                </a>
              </li>
              <li class="page-item" [ngClass]="{'disabled': paginacion.paginaActual === paginacion.totalPaginas}">
                <a class="page-link" (click)="cambiarPagina(paginacion.totalPaginas)" aria-label="Última" tabindex="-1">
                  <span aria-hidden="true">&raquo;</span>
                </a>
              </li>
            </ul>
          </nav>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="modal-backdrop fade show" *ngIf="modalEditarVisible || modalPerfilVisible"></div>